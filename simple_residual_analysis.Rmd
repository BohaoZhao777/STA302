---
title: "Ames Housing Residual plot"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```



```{r load-packages}

library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)
```



```{r load-data}

df <- read_csv("ames_11_predictors.csv", show_col_types = FALSE)


df <- df %>%
  mutate(
    Street = as.factor(Street),
    Utilities = as.factor(Utilities)
  )

cat("Data dimensions:", nrow(df), "rows x", ncol(df), "columns\n")
cat("Note: This file contains 11 predictor variables for model analysis\n")
cat("Variables included:\n")
cat("- Categorical: Street, Utilities\n")
cat("- Numerical: Total_Bsmt_SF, Bedroom_AbvGr, Garage_Cars, Pool_Area, Gr_Liv_Area, Wood_Deck_SF, Fireplaces, Lot_Area, TotRms_AbvGrd\n")
cat("- Response: Sale_Price\n")
cat("- Interaction: Street:Garage_Cars\n")
cat("Total model terms: 12 (11 predictors + 1 interaction)\n")
```



```{r fit-model}

# Fit model with 11 predictors + 1 interaction term (12 total terms)
mod <- lm(
  Sale_Price ~ Total_Bsmt_SF + Bedroom_AbvGr + Garage_Cars + Pool_Area + 
    Gr_Liv_Area + Wood_Deck_SF + Fireplaces + Lot_Area + TotRms_AbvGrd + 
    Street + Utilities + Street:Garage_Cars,
  data = df
)

cat("Model with 11 predictors + 1 interaction term (12 total terms):\n")
summary(mod)

# Display model coefficients and interaction effects
cat("\n=== Model Coefficients ===\n")
coef_summary <- summary(mod)$coefficients
print(round(coef_summary, 4))

# Check interaction term significance
interaction_terms <- rownames(coef_summary)[grepl(":", rownames(coef_summary))]
if(length(interaction_terms) > 0) {
  cat("\n=== Interaction Terms ===\n")
  for(term in interaction_terms) {
    p_val <- coef_summary[term, "Pr(>|t|)"]
    cat(term, ": p-value =", format.pval(p_val), "\n")
    if(p_val < 0.05) {
      cat("  -> Significant interaction (p < 0.05)\n")
    } else {
      cat("  -> Non-significant interaction (p >= 0.05)\n")
    }
  }
}
```



```{r calculate-residuals}

resid_std <- rstudent(mod)
fit_vals  <- fitted(mod)

# Define predictor variables
predictors_num <- c("Total_Bsmt_SF", "Bedroom_AbvGr", "Garage_Cars", "Pool_Area", 
                    "Gr_Liv_Area", "Wood_Deck_SF", "Fireplaces", "Lot_Area", "TotRms_AbvGrd")
predictors_cat <- c("Street", "Utilities")

cat("Numerical predictors:", length(predictors_num), "\n")
cat("Categorical predictors:", length(predictors_cat), "\n")
cat("Total predictors:", length(predictors_num) + length(predictors_cat), "\n")
cat("Plus 1 interaction term: Street:Garage_Cars\n")
cat("Total model terms: 12 (11 predictors + 1 interaction)\n")

# Model performance metrics
cat("\n=== Model Performance ===\n")
cat("R-squared:", round(summary(mod)$r.squared, 4), "\n")
cat("Adjusted R-squared:", round(summary(mod)$adj.r.squared, 4), "\n")
cat("F-statistic:", round(summary(mod)$fstatistic[1], 2), "\n")
cat("p-value (F-test):", format.pval(pf(summary(mod)$fstatistic[1], summary(mod)$fstatistic[2], summary(mod)$fstatistic[3], lower.tail = FALSE)), "\n")
```



```{r residual-functions}

plot_resid_vs_numeric <- function(x, xlab){
  ggplot(data = data.frame(x = x, resid = resid_std), aes(x = x, y = resid)) +
    geom_point(size = 1.2, alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = xlab, y = "Studentized residuals",
         title = paste("Residuals vs", xlab)) +
    theme_minimal()
}


plot_resid_vs_factor <- function(f, flab){
  ggplot(data = data.frame(f = f, resid = resid_std), aes(x = f, y = resid)) +
    geom_boxplot(outlier.size = 0.9) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = flab, y = "Studentized residuals",
         title = paste("Residuals vs", flab)) +
    theme_minimal()
}


p_fitted <- ggplot(data = data.frame(fit = fit_vals, resid = resid_std),
                   aes(x = fit, y = resid)) +
  geom_point(size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = "Fitted values", y = "Studentized residuals",
       title = "Residuals vs Fitted") +
  theme_minimal()
```



```{r generate-plots}

# Generate plots for numerical predictors
plots_pred_num <- lapply(predictors_num, function(v){
  plot_resid_vs_numeric(df[[v]], v)
})

# Generate plots for categorical predictors
plots_pred_cat <- lapply(predictors_cat, function(v){
  plot_resid_vs_factor(df[[v]], v)
})

# Combine all plots
all_plots <- c(list(p_fitted), plots_pred_num, plots_pred_cat)

cat("Generated", length(all_plots), "residual plots total\n")
cat("- 1 fitted values plot\n")
cat("-", length(plots_pred_num), "numerical predictor plots\n")
cat("-", length(plots_pred_cat), "categorical predictor plots\n")
cat("Model includes 11 predictors + 1 interaction term (12 total terms)\n")
```



```{r display-grid, fig.width=18, fig.height=15}

# Adjust grid layout for more plots
final_grid <- wrap_plots(all_plots, ncol = 4)

# Display the grid
final_grid

cat("Grid layout: 4 columns with", length(all_plots), "total plots\n")
```



```{r save-plot}

# Save the comprehensive residual plots
ggsave("residual_plots_12_terms.png", final_grid, width = 16, height = 12, dpi = 300)
cat("Image saved as: residual_plots_12_terms.png\n")
cat("This includes plots for all 11 predictors + 1 interaction term (12 total terms)\n")
```

---



