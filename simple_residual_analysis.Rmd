---
title: "Ames Housing Residual plot"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```



```{r load-packages}

library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)
```



```{r load-data}

# Check if CSV file exists, if not create it
if(!file.exists("ames_11_predictors.csv")) {
  cat("CSV file not found. Running export script to create it...\n")
  source("export_11_predictors.R")
}

df <- read_csv("ames_11_predictors.csv", show_col_types = FALSE)

# Convert categorical variables to factors
df <- df %>%
  mutate(
    Street = as.factor(Street),
    Utilities = as.factor(Utilities)
  )

cat("Data dimensions:", nrow(df), "rows x", ncol(df), "columns\n")
cat("Note: This file contains 11 predictor variables for model analysis\n")
cat("Variables included:\n")
cat("- Categorical: Street, Utilities\n")
cat("- Numerical: Total_Bsmt_SF, Bedroom_AbvGr, Garage_Cars, Pool_Area, Gr_Liv_Area, Fireplaces, Lot_Area, TotRms_AbvGrd\n")
cat("- Response: Sale_Price\n")
cat("- Interaction: Street:Garage_Cars\n")
cat("Total model terms: 11 (10 predictors + 1 interaction)\n")
```



```{r fit-model}

# Fit model with 10 predictors + 1 interaction term (11 total terms)
mod <- lm(
  Sale_Price ~ Total_Bsmt_SF + Bedroom_AbvGr + Garage_Cars + Pool_Area + 
    Gr_Liv_Area + Fireplaces + Lot_Area + TotRms_AbvGrd + 
    Street + Utilities + Street:Garage_Cars,
  data = df
)

cat("Model with 10 predictors + 1 interaction term (11 total terms):\n")
summary(mod)

# Display model coefficients and interaction effects
cat("\n=== Model Coefficients ===\n")
coef_summary <- summary(mod)$coefficients
print(round(coef_summary, 4))

# Check interaction term significance
interaction_terms <- rownames(coef_summary)[grepl(":", rownames(coef_summary))]
if(length(interaction_terms) > 0) {
  cat("\n=== Interaction Terms ===\n")
  for(term in interaction_terms) {
    p_val <- coef_summary[term, "Pr(>|t|)"]
    cat(term, ": p-value =", format.pval(p_val), "\n")
    if(p_val < 0.05) {
      cat("  -> Significant interaction (p < 0.05)\n")
    } else {
      cat("  -> Non-significant interaction (p >= 0.05)\n")
    }
  }
}

# Calculate and display 95% confidence intervals
cat("\n=== 95% Confidence Intervals for Coefficients ===\n")
ci_95 <- confint(mod, level = 0.95)
print(round(ci_95, 4))
```



```{r calculate-residuals}

resid_std <- rstudent(mod)
fit_vals  <- fitted(mod)

# Define predictor variables
predictors_num <- c("Total_Bsmt_SF", "Bedroom_AbvGr", "Garage_Cars", "Pool_Area", 
                    "Gr_Liv_Area", "Fireplaces", "Lot_Area", "TotRms_AbvGrd")
predictors_cat <- c("Street", "Utilities")

cat("Numerical predictors:", length(predictors_num), "\n")
cat("Categorical predictors:", length(predictors_cat), "\n")
cat("Total predictors:", length(predictors_num) + length(predictors_cat), "\n")
cat("Plus 1 interaction term: Street:Garage_Cars\n")
cat("Total model terms: 11 (10 predictors + 1 interaction)\n")

# Model performance metrics
cat("\n=== Model Performance ===\n")
cat("R-squared:", round(summary(mod)$r.squared, 4), "\n")
cat("Adjusted R-squared:", round(summary(mod)$adj.r.squared, 4), "\n")
cat("F-statistic:", round(summary(mod)$fstatistic[1], 2), "\n")
cat("p-value (F-test):", format.pval(pf(summary(mod)$fstatistic[1], summary(mod)$fstatistic[2], summary(mod)$fstatistic[3], lower.tail = FALSE)), "\n")
```

```{r normality-tests}

cat("\n=== Normality Assumption Tests ===\n")

# Shapiro-Wilk test
shapiro_test <- shapiro.test(resid_std)
cat("Shapiro-Wilk Test:\n")
cat("  W-statistic =", round(shapiro_test$statistic, 4), "\n")
cat("  p-value =", format.pval(shapiro_test$p.value), "\n")
if(shapiro_test$p.value < 0.05) {
  cat("  -> Reject normality assumption (p < 0.05)\n")
} else {
  cat("  -> Fail to reject normality assumption (p >= 0.05)\n")
}

# Anderson-Darling test (if nortest package is available)
if(require(nortest, quietly = TRUE)) {
  ad_test <- ad.test(resid_std)
  cat("\nAnderson-Darling Test:\n")
  cat("  A-statistic =", round(ad_test$statistic, 4), "\n")
  cat("  p-value =", format.pval(ad_test$p.value), "\n")
  if(ad_test$p.value < 0.05) {
    cat("  -> Reject normality assumption (p < 0.05)\n")
  } else {
    cat("  -> Fail to reject normality assumption (p >= 0.05)\n")
  }
} else {
  cat("\nAnderson-Darling Test: nortest package not available\n")
}

# Kolmogorov-Smirnov test
ks_test <- ks.test(resid_std, "pnorm", mean = mean(resid_std), sd = sd(resid_std))
cat("\nKolmogorov-Smirnov Test:\n")
cat("  D-statistic =", round(ks_test$statistic, 4), "\n")
cat("  p-value =", format.pval(ks_test$p.value), "\n")
if(!is.na(ks_test$p.value) && ks_test$p.value < 0.05) {
  cat("  -> Reject normality assumption (p < 0.05)\n")
} else if(!is.na(ks_test$p.value)) {
  cat("  -> Fail to reject normality assumption (p >= 0.05)\n")
} else {
  cat("  -> p-value not available\n")
}
```



```{r residual-functions}

plot_resid_vs_numeric <- function(x, xlab){
  ggplot(data = data.frame(x = x, resid = resid_std), aes(x = x, y = resid)) +
    geom_point(size = 1.2, alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = xlab, y = "Studentized residuals",
         title = paste("Residuals vs", xlab)) +
    theme_minimal()
}


plot_resid_vs_factor <- function(f, flab){
  ggplot(data = data.frame(f = f, resid = resid_std), aes(x = f, y = resid)) +
    geom_boxplot(outlier.size = 0.9) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = flab, y = "Studentized residuals",
         title = paste("Residuals vs", flab)) +
    theme_minimal()
}


p_fitted <- ggplot(data = data.frame(fit = fit_vals, resid = resid_std),
                   aes(x = fit, y = resid)) +
  geom_point(size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = "Fitted values", y = "Studentized residuals",
       title = "Residuals vs Fitted") +
  theme_minimal()
```



```{r generate-plots}

# Generate plots for numerical predictors
plots_pred_num <- lapply(predictors_num, function(v){
  plot_resid_vs_numeric(df[[v]], v)
})

# Generate plots for categorical predictors
plots_pred_cat <- lapply(predictors_cat, function(v){
  plot_resid_vs_factor(df[[v]], v)
})

# Create interaction plot: Street:Garage_Cars
df_interaction <- df %>%
  mutate(interaction_term = interaction(Street, Garage_Cars, sep = ":"))
p_interaction <- plot_resid_vs_factor(df_interaction$interaction_term, "Street:Garage_Cars")

# Combine all plots
all_plots <- c(list(p_fitted), plots_pred_num, plots_pred_cat, list(p_interaction))

cat("Generated", length(all_plots), "residual plots total\n")
cat("- 1 fitted values plot\n")
cat("-", length(plots_pred_num), "numerical predictor plots\n")
cat("-", length(plots_pred_cat), "categorical predictor plots\n")
cat("- 1 interaction term plot\n")
cat("Model includes 10 predictors + 1 interaction term (11 total terms)\n")
```



```{r normality-plots, fig.width=16, fig.height=6}

# Create a 2-panel layout for normality plots
par(mfrow = c(1, 2), mar = c(4, 4, 3, 2))

# Q-Q plot: observe tail deviations
qqnorm(resid_std, main = "Normal Q-Q Plot (Studentized Residuals)")
qqline(resid_std, col = "red", lwd = 2)

# Histogram to observe distribution
hist(resid_std,
     breaks = 40,
     col = "lightblue",
     main = "Histogram of Studentized Residuals",
     xlab = "Studentized Residuals")

# Reset plotting parameters
par(mfrow = c(1, 1))

cat("Normality assumption diagnostic plots\n")
```

```{r display-grid-fitted, fig.width=12, fig.height=8}

# Display only the fitted plot
p_fitted

cat("Residual vs Fitted values plot\n")
```

```{r display-grid-predictors, fig.width=18, fig.height=15}

# Display only the predictor plots (including interaction)
predictor_plots <- c(plots_pred_num, plots_pred_cat, list(p_interaction))
predictor_grid <- wrap_plots(predictor_plots, ncol = 4)

# Display the grid
predictor_grid

cat("Grid layout: 4 columns with", length(predictor_plots), "predictor plots (including interaction)\n")
```



```{r save-normality-plot}

# Save normality plots
png("normality_plots.png", width = 16, height = 6, units = "in", res = 300)
par(mfrow = c(1, 2), mar = c(4, 4, 3, 2))
qqnorm(resid_std, main = "Normal Q-Q Plot (Studentized Residuals)")
qqline(resid_std, col = "red", lwd = 2)
hist(resid_std, breaks = 40, col = "lightblue",
     main = "Histogram of Studentized Residuals",
     xlab = "Studentized Residuals")
par(mfrow = c(1, 1))
dev.off()

cat("Image saved as: normality_plots.png\n")
```

```{r save-plot}

# Save the residual vs fitted plot
ggsave("residual_vs_fitted.png", p_fitted, width = 12, height = 8, dpi = 300)
cat("Image saved as: residual_vs_fitted.png\n")

# Save the residual vs predictors grid (including interaction)
ggsave("residual_vs_predictors.png", predictor_grid, width = 16, height = 12, dpi = 300)
cat("Image saved as: residual_vs_predictors.png\n")
cat("This includes plots for all 10 predictors + 1 interaction term\n")
```

---



