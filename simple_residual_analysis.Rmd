---
title: "Ames Housing Residual plot"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```



```{r load-packages}

library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)
```



```{r load-data}

df <- read_csv("ames_housing_model.csv", show_col_types = FALSE)


df <- df %>%
  mutate(
    Street = as.factor(Street)
  )

cat("数据维度:", nrow(df), "行 x", ncol(df), "列\n")
cat("注意：此文件只包含模型分析需要的9个预测变量\n")
```



```{r fit-model}

mod <- lm(
  Sale_Price ~ Total_Bsmt_SF + Garage_Cars + Pool_Area + Gr_Liv_Area +
    Fireplaces + Lot_Area + Bedroom_AbvGr + TotRms_AbvGrd + Street,
  data = df
)


summary(mod)
```



```{r calculate-residuals}

resid_std <- rstudent(mod)
fit_vals  <- fitted(mod)


predictors_num <- c("Total_Bsmt_SF","Garage_Cars","Pool_Area","Gr_Liv_Area",
                    "Fireplaces","Lot_Area","Bedroom_AbvGr","TotRms_AbvGrd")
predictor_cat  <- "Street"
```



```{r residual-functions}

plot_resid_vs_numeric <- function(x, xlab){
  ggplot(data = data.frame(x = x, resid = resid_std), aes(x = x, y = resid)) +
    geom_point(size = 1.2, alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = xlab, y = "Studentized residuals",
         title = paste("Residuals vs", xlab)) +
    theme_minimal()
}


plot_resid_vs_factor <- function(f, flab){
  ggplot(data = data.frame(f = f, resid = resid_std), aes(x = f, y = resid)) +
    geom_boxplot(outlier.size = 0.9) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = flab, y = "Studentized residuals",
         title = paste("Residuals vs", flab)) +
    theme_minimal()
}


p_fitted <- ggplot(data = data.frame(fit = fit_vals, resid = resid_std),
                   aes(x = fit, y = resid)) +
  geom_point(size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = "Fitted values", y = "Studentized residuals",
       title = "Residuals vs Fitted") +
  theme_minimal()
```



```{r generate-plots}

plots_pred <- lapply(predictors_num, function(v){
  plot_resid_vs_numeric(df[[v]], v)
})


p_street <- plot_resid_vs_factor(df[[predictor_cat]], predictor_cat)

all_plots <- c(list(p_fitted), plots_pred, list(p_street))
```



```{r display-grid, fig.width=15, fig.height=12}

final_grid <- wrap_plots(all_plots, ncol = 3)


final_grid
```



```{r save-plot}

ggsave("residual_plots_grid.png", final_grid, width = 14, height = 10, dpi = 300)
cat("图片已保存为: residual_plots_grid.png\n")
```

---



