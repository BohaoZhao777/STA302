# --- 0) 环境与数据 ---
# 若没有这些包，请先安装：
# install.packages(c("ggplot2", "patchwork", "readr", "dplyr"))

library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)

# 读取你上传的数据（改路径请保持与文件位置一致）
df <- read_csv("ames_housing_model.csv", show_col_types = FALSE)

# 确保类型：把 Street 作为因子；其它数值列转 numeric（若已为 numeric 可忽略）
df <- df %>%
  mutate(
    Street = as.factor(Street)
  )

# --- 1) 拟合“初步模型” ---
# 响应：Sale_Price
# 9 个自变量：Total_Bsmt_SF, Garage_Cars, Pool_Area, Gr_Liv_Area, Fireplaces,
#             Lot_Area, Bedroom_AbvGr, TotRms_AbvGrd, Street
mod <- lm(
  Sale_Price ~ Total_Bsmt_SF + Garage_Cars + Pool_Area + Gr_Liv_Area +
    Fireplaces + Lot_Area + Bedroom_AbvGr + TotRms_AbvGrd + Street,
  data = df
)

# 学生化残差与拟合值
resid_std <- rstudent(mod)
fit_vals  <- fitted(mod)

# 需要画残差的 9 个自变量
predictors_num <- c("Total_Bsmt_SF","Garage_Cars","Pool_Area","Gr_Liv_Area",
                    "Fireplaces","Lot_Area","Bedroom_AbvGr","TotRms_AbvGrd")
predictor_cat  <- "Street"   # 分类变量

# --- 2) 作图函数 ---
# (a) 数值型自变量：散点 + y=0 参考线
plot_resid_vs_numeric <- function(x, xlab){
  ggplot(data = data.frame(x = x, resid = resid_std), aes(x = x, y = resid)) +
    geom_point(size = 1.2, alpha = 0.8) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = xlab, y = "Studentized residuals",
         title = paste("Residuals vs", xlab)) +
    theme_minimal()
}

# (b) 分类变量：箱线图 + y=0 参考线（也可改为抖动散点）
plot_resid_vs_factor <- function(f, flab){
  ggplot(data = data.frame(f = f, resid = resid_std), aes(x = f, y = resid)) +
    geom_boxplot(outlier.size = 0.9) +
    geom_hline(yintercept = 0, linetype = 2) +
    labs(x = flab, y = "Studentized residuals",
         title = paste("Residuals vs", flab)) +
    theme_minimal()
}

# (c) Residuals vs Fitted
p_fitted <- ggplot(data = data.frame(fit = fit_vals, resid = resid_std),
                   aes(x = fit, y = resid)) +
  geom_point(size = 1.2, alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = "Fitted values", y = "Studentized residuals",
       title = "Residuals vs Fitted") +
  theme_minimal()

# --- 3) 生成 9 张“残差 vs 自变量”图 ---
plots_pred <- lapply(predictors_num, function(v){
  plot_resid_vs_numeric(df[[v]], v)
})
p_street <- plot_resid_vs_factor(df[[predictor_cat]], predictor_cat)

# 合并：共 10 张图（1 张 vs Fitted + 8 张数值 + 1 张 Street）
all_plots <- c(list(p_fitted), plots_pred, list(p_street))

# --- 4) 网格排版：每行 3 张，自动换行（共 4 行，最后一行只有 1 张也没问题） ---
# 你也可以改 ncol = 2（每行 2 张），或 ncol = 3（每行 3 张）
final_grid <- wrap_plots(all_plots, ncol = 3)

# 显示到绘图窗口
final_grid

# 如果需要保存成高清图片（推荐在作业报告里引用）：
# ggsave("residual_plots_grid.png", final_grid, width = 14, height = 10, dpi = 300)
